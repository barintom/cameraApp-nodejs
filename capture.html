<html>

<head>
	<title>Capture doc</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
	<script lang="javascript/text">
	//var video = null;
	
		window.addEventListener("DOMContentLoaded", function() {
	
	var canvas = document.getElementById("canvas"),
		context = canvas.getContext("2d"),
		video = document.getElementById("video"),
		videoObj = { "video": true },
		errBack = function(error) {
			console.log("Video capture error: ", error.code); 
		};
	
	if(navigator.getUserMedia) { 
		navigator.getUserMedia(videoObj, function(stream) {
			video.src = stream;
			video.play();
		}, errBack);
	} else if(navigator.webkitGetUserMedia) { 
		navigator.webkitGetUserMedia(videoObj, function(stream){
			video.src = window.webkitURL.createObjectURL(stream);
			video.play();
		}, errBack);
	}
	else if(navigator.mozGetUserMedia) { 
		navigator.mozGetUserMedia(videoObj, function(stream){
			video.src = window.URL.createObjectURL(stream);
			video.play();
		}, errBack);
	}
	
	
	document.getElementById("snap").addEventListener("click", function() {
		//context.drawImage(video, 0, 0, 640, 480);
		
		 //   function takePicture() {
       // if (localMediaStream) {
            context.drawImage(video, 0, 0, 320, 240);
            
            var myform = new FormData();
            myform.append("imageFile", canvas.toDataURL("image/png"));
            //FIXME: use jquery
            var req = new XMLHttpRequest();
            req.open("POST", "/recognize");
            req.onreadystatechange = function() {
                if (req.readyState == 4) {
                    //document.getElementById('statusText').innerHTML = req.responseText;
					var out = JSON.parse(req.response);
					 console.log(out);
					$('#age').val(out.age);
					$('input[name=gender][value=' + out.gender + ']').prop('checked', true);
                   
                   // setTimeout(doFaceDetection, 2000);
                } else {
                   console.log("error")
                }
            };
            
            req.send(myform);
			video.pause();
        //}
   // }


	});
}, false);
	</script>
</head>

<body>
	<div class="container-fluid" style="min-width:400px">
		<h3>Add new person</h3>
		<div class="jumbotron">

			<form id="capture" action="store" method="post" class="form-horizontal" role="form">
				<div class="form-group">
					<label class="control-label col-sm-2" for="name">Name:</label>
					<div class="col-sm-10">
						<input type="text" name="name" id="name" class="form-control" />
					</div>
				</div>
				<div class="form-group">
					<label class="control-label col-sm-2" for="gender">Gender:</label>
					<div class="col-sm-10">
						<label class="radio-inline">
							<input type="radio" name="gender" id="gender" value="male" />Male</label>
						<label class="radio-inline">
							<input type="radio" name="gender" id="gender" value="female" />Female</label>
					</div>
				</div>
				<div class="form-group">
					<label class="control-label col-sm-2" for="name">Age:</label>
					<div class="col-sm-10">
						<input type="text" name="age" id="age" class="form-control" />
					</div>
				</div>

				<div class="form-group">
					<label class="control-label col-sm-2" for="photo">Photo:</label>
					<div class="col-sm-10">
						<video id="video" width="320" height="240" autoplay></video>
						<canvas id="canvas" width="320" height="240" style="display:none"></canvas>
					</div>
				</div>
				<div class="form-group">
					<label class="control-label col-sm-2" for="snap"></label>
					<div class="col-sm-10">
						<a class="btn btn-primary btn-lg" href="#" role="button" id="snap">Capture</a>
						<a class="btn btn-primary btn-lg" href="#" role="button" id="snap">Store</a>
					</div>
				</div>


			</form>


		</div>
	</div>


</body>

</html>