var FormData = require('form-data');


var recognizeImage = function (hostname, url, readStream, callback) {
	process.nextTick(function processImage() { //get async
		var form = new FormData();
		form.append('file.png', readStream, { contentType: 'image/x-png' });
		form.submit({ //Submit request		
			host: hostname, path: url,
			headers: {
				'Content-Type': 'multipart/mixed; boundary=' + form.getBoundary()
			}
		}, function (err, r) {
			r.on('data', function faceAttributes(data) {
				var jsonObject = JSON.parse(data);
				console.log(jsonObject);
				var tags = jsonObject.photos[0].tags[0];
				if (tags) {
					var attributes = tags.attributes;
					console.log("age:" + attributes.age_est.value + ", gender:" + attributes.gender.value);
					callback({ age: attributes.age_est.value, gender: attributes.gender.value });
				} else {
					callback({ message: 'Face not recognized' });
				}
			});
		});
	});
	return;
}

exports.recognizeImage = recognizeImage;